<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css">
</head>

<body>
    <h1>Map Library</h1>
    <div id="mapa" style="height: 500px;">

    </div>

    <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"></script>
    <script src="https://unpkg.com/esri-leaflet@3.0.8/dist/esri-leaflet.js"></script>
    <script src="https://unpkg.com/esri-leaflet-geocoder@2.2.13/dist/esri-leaflet-geocoder.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-geosearch/2.7.0/bundle.min.js"></script>
    <script>
        (function () {
            const lat = 20.67444163271174;
            const lng = -103.38739216304566;
            const mapa = L.map('mapa').setView([lat, lng], 16);
            let marker;

            // Utilizar provider y geocoder
            const geocodeService = L.esri.Geocoding.geocodeService();

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(mapa);

            // El pin
            marker = new L.marker([lat, lng], {
                draggable: true,
                autoPan: true
            })
                .addTo(mapa)

            // Detectar el movimiento del pin
            marker.on('moveend', function (event) {
                marker = event.target

                const posicion = marker.getLatLng()

                // Centrar mapa al detectar evento
                mapa.panTo(new L.LatLng(posicion.lat, posicion.lng))

                // Obtener la información de las calles al soltar el pin
                geocodeService.reverse().latlng(posicion, 13).run(function (err, result) {

                    // Objeto con info de la ubicación del pin
                    console.log(result)

                    // Personalizar popup de pin
                    marker.bindPopup(result.address.LongLabel)
                })
            })
        })()
    </script>
</body>

</html>